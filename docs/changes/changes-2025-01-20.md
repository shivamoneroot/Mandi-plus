# Changes Log - 2025-01-20

## What Changed

### 1. User-Invoice Relationship (One-to-Many)
- **Added relation between User and Invoice entities**
  - `Invoice` entity now has `ManyToOne` relation to `User`
  - `User` entity now has `OneToMany` relation to `Invoice[]`
  - One user can have many invoices

### 2. Database Migration
- **Created migration**: `1766500000000-add-user-relation-to-invoice.ts`
  - Adds `userId` column (UUID, NOT NULL) to `invoices` table
  - Creates foreign key constraint with CASCADE delete
  - Creates index on `userId` for better query performance

### 3. Create Invoice DTO Update
- **Updated `CreateInvoiceDto`**:
  - Added required `userId` field (UUID validation)
  - Invoice creation now requires a valid user ID

### 4. Invoice Service Updates
- **Updated `InvoicesService`**:
  - Added `User` repository injection
  - `create()` method now validates user exists before creating invoice
  - `create()` method associates invoice with user
  - Added new method `findByUserId(userId: string)` to fetch all invoices for a user
  - Updated `findAll()`, `findOne()`, and `findByInvoiceNumber()` to include `user` relation

### 5. Invoice Controller Updates
- **Updated `InvoicesController`**:
  - Added new endpoint: `GET /invoices/user/:userId`
  - Returns all invoices for a specific user
  - Updated Swagger documentation to include `userId` in create invoice schema

### 6. Module Updates
- **Updated `InvoicesModule`**:
  - Added `User` entity to TypeORM feature imports

## Why It Changed

- Requirement to track which user created each invoice
- Need for user-specific invoice queries
- Better data organization and access control foundation
- Enables future features like user-based filtering and permissions

## How It Affects the Current Code

### Database Migration Required
- **NEW MIGRATION**: `1766500000000-add-user-relation-to-invoice.ts` must be run
  ```bash
  pnpm run migration:run
  ```

### Breaking Changes
- **`POST /invoices`** now requires `userId` field in the request body
  - Previous requests without `userId` will fail validation
  - All invoice creation requests must include a valid user UUID

### New API Endpoint
- **`GET /invoices/user/:userId`** - Get all invoices for a user
  - Returns array of invoices with `truck` and `user` relations
  - Returns 404 if user doesn't exist
  - Ordered by creation date (newest first)

### Updated API Responses
- All invoice responses now include `user` object:
  ```json
  {
    "id": "invoice-uuid",
    "invoiceNumber": "INV-2024-001",
    "user": {
      "id": "user-uuid",
      "name": "John Doe",
      "mobileNumber": "+919876543210"
    },
    "truck": { ... },
    ...
  }
  ```

## Developer Notes

### Next Steps
1. **Run the migration**:
   ```bash
   pnpm run migration:run
   ```

2. **Update existing invoices** (if any):
   - Existing invoices in the database will need a `userId` assigned
   - You may need to create a data migration script to assign users to existing invoices
   - Or manually update invoices via SQL:
     ```sql
     -- Example: Assign all invoices to a default user (replace with actual user ID)
     UPDATE invoices SET "userId" = 'default-user-uuid' WHERE "userId" IS NULL;
     ```

3. **Update frontend/client code**:
   - All invoice creation requests must include `userId` field
   - Use the new endpoint `GET /invoices/user/:userId` to fetch user-specific invoices

4. **Test the changes**:
   - Test creating invoice with valid `userId`
   - Test creating invoice with invalid `userId` (should return 404)
   - Test fetching invoices by user ID
   - Verify user relation is included in all invoice responses

### Migration Rollback
If you need to rollback this migration:
```bash
pnpm run migration:revert
```

This will:
- Drop the foreign key constraint
- Drop the index on `userId`
- Remove the `userId` column from `invoices` table

