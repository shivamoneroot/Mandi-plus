# Changes - 2025-12-23

## What Changed

### 1. Complete CRUD API Implementation
- **Users Module**: Full CRUD operations for user management
  - Created `users/` module with controller, service, and DTOs
  - Endpoints: `POST /users`, `GET /users`, `GET /users/:id`, `PATCH /users/:id`, `DELETE /users/:id`
  - Supports all user identity types (SUPPLIER, BUYER, TRANSPORTER, AGENT)

- **Trucks Module**: Full CRUD operations for truck management
  - Created `trucks/` module with controller, service, and DTOs
  - Endpoints: `POST /trucks`, `GET /trucks`, `GET /trucks/:id`, `PATCH /trucks/:id`, `DELETE /trucks/:id`
  - Includes claim count tracking

- **Invoices Module**: Full CRUD operations with file upload and PDF generation
  - Created `invoices/` module with controller, service, and DTOs
  - Endpoints: `POST /invoices`, `GET /invoices`, `GET /invoices/:id`, `PATCH /invoices/:id`, `DELETE /invoices/:id`
  - Supports multipart/form-data for weighment slip file uploads
  - Asynchronous PDF generation using BullMQ

### 2. File Upload & Storage Service
- **Storage Module**: Created cloud storage service for file uploads
  - Supports Cloudinary (default) and Cloudflare R2 (structure prepared)
  - Handles weighment slip image uploads
  - Handles PDF uploads
  - Created `storage/` module with `StorageService`

### 3. PDF Generation Service
- **PDF Module**: Created PDF generation service using PDFKit
  - Generates professional invoice PDFs
  - Embeds weighment slip images into PDF
  - Includes all invoice details (supplier, buyer, items, vehicle, etc.)
  - Created `pdf/` module with `PdfService`

### 4. Asynchronous Job Processing
- **BullMQ Integration**: Set up BullMQ for async invoice PDF generation
  - Created `queue/` module with Redis connection
  - Created `InvoicePdfProcessor` to handle PDF generation jobs
  - PDF generation happens asynchronously after invoice creation/update
  - Jobs are queued automatically when invoices are created or updated

### 5. Database Integration
- **TypeORM Integration**: Fully integrated TypeORM in `AppModule`
  - All entities (User, Truck, Invoice) are now connected
  - Database configuration from `config/database.config.ts`
  - Added ConfigModule for environment variable management

### 6. Entity Updates
- **Invoice Entity**: Added `pdfUrl` field to store generated PDF URL
  - Created migration: `1766250000000-add-pdf-url-to-invoice.ts`
  - PDF URL is updated after successful PDF generation

### 7. Form Data Parsing
- **ParseFormDataPipe**: Created custom pipe to handle multipart/form-data
  - Parses array fields from form data (JSON strings or comma-separated)
  - Converts string numbers to actual numbers
  - Converts string booleans to actual booleans
  - Created `common/pipes/parse-form-data.pipe.ts`

## Why It Changed

- The project had database entities defined but no functional APIs
- Need for complete CRUD operations for all entities (Users, Trucks, Invoices)
- Requirement to generate PDF invoices with embedded weighment slips
- Need for asynchronous processing to avoid blocking API requests during PDF generation
- Requirement to upload files (weighment slips) and store them in cloud storage
- Need for proper file handling and storage integration

## How It Affects the Current Code

### Database Migrations Required
- **NEW MIGRATION**: `1766250000000-add-pdf-url-to-invoice.ts` must be run
  ```bash
  pnpm run migration:run
  ```

### Environment Variables Required
Add these to your `.env.development` (or `.env.production`) file:

```env
# Database
DB_HOST=localhost
DB_PORT=5432
DB_USER=your_db_user
DB_PASS=your_db_password
DB_NAME=your_db_name

# Redis (for BullMQ)
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=  # Optional

# Storage (Cloudinary - default)
STORAGE_TYPE=cloudinary
CLOUDINARY_CLOUD_NAME=your_cloud_name
CLOUDINARY_API_KEY=your_api_key
CLOUDINARY_API_SECRET=your_api_secret

# Server
PORT=3005
NODE_ENV=development
```

### New Dependencies
The following packages were added:
- `@nestjs/bullmq`, `bullmq` - For async job processing
- `pdfkit`, `@types/pdfkit` - For PDF generation
- `multer`, `@types/multer` - For file uploads
- `cloudinary` - For cloud storage
- `axios` - For HTTP requests (downloading images)
- `sharp`, `@types/sharp` - For image processing
- `@aws-sdk/client-s3`, `@aws-sdk/s3-request-presigner` - For R2 support (optional)

### API Changes
- **New Endpoints**: All CRUD endpoints for Users, Trucks, and Invoices
- **File Upload**: Invoice creation/update endpoints now accept `weighmentSlips` files via multipart/form-data
- **Response Format**: All endpoints return proper JSON responses with Swagger documentation
- **Swagger UI**: Available at `/api/docs` - fully documented API

### Invoice Creation Flow
1. Client sends POST request to `/invoices` with invoice data and weighment slip files
2. Weighment slips are uploaded to Cloudinary/R2
3. Invoice is saved to database with weighment slip URLs
4. PDF generation job is queued in BullMQ
5. Job processor generates PDF with embedded weighment slips
6. PDF is uploaded to storage
7. Invoice is updated with PDF URL

## Developer Notes

### Next Steps

1. **Run Database Migration**:
   ```bash
   pnpm run migration:run
   ```

2. **Set Up Redis**: 
   - Install and run Redis server (required for BullMQ)
   - Update `REDIS_HOST` and `REDIS_PORT` in `.env` if different

3. **Configure Cloudinary**:
   - Sign up at cloudinary.com
   - Get API credentials
   - Add to `.env` file

4. **Test the APIs**:
   - Start the server: `pnpm run start:dev`
   - Visit Swagger UI: `http://localhost:3005/api/docs`
   - Test endpoints using Swagger UI

5. **Monitor Job Queue**:
   - BullMQ jobs are processed automatically
   - Check logs for PDF generation status
   - Failed jobs will be retried automatically

### Known Issues

1. **ProductName Type Mismatch**: 
   - The `Invoice` entity has `productName` typed as `string[]` but the database column is `varchar`
   - Currently handled by JSON stringifying the array when saving
   - Consider creating a migration to change the column type to `text array` for better data integrity

2. **R2 Storage**: 
   - R2 storage implementation is not complete (placeholder code)
   - Currently defaults to Cloudinary
   - To implement R2, complete the `uploadToR2` and `uploadPdfToR2` methods in `StorageService`

### Testing Recommendations

- Test file uploads with various image formats (JPEG, PNG, etc.)
- Test PDF generation with multiple weighment slips
- Test async job processing with Redis
- Test invoice creation/update flows
- Verify PDF URLs are correctly stored after generation

### API Documentation

All APIs are documented with Swagger/OpenAPI:
- Access at: `http://localhost:3005/api/docs`
- All endpoints include request/response schemas
- File upload endpoints show multipart/form-data structure

